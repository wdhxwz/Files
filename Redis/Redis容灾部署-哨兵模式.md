## Redis容灾部署-哨兵模式

Redis的哨兵系统本质上只是一个redis进程（运行在特殊模式下的 Redis 服务器），用于管理多个Redis节点，该系统执行下面三件事：

- 监控：检查主服务器和从服务器是否正常运行
- 提醒：当监控到某个节点出现问题时，发生通知
- 自动故障转移：当主服务器不能正常工作时，进行故障自动转移操作，将某个从服务器升级为新的主服务器

Redis哨兵系统是一个分布式系统，可以进行集群部署，避免单点故障。

### 哨兵配置

	# 指定哨兵运行的端口
	port 26379
	
	# 守护进程模式
	daemonize no
	
	# 关闭保护模式
	protected-mode no
	
	# 指明日志文件名
	logfile "/data/logs/redis/sentinel26379.log"
	
	# 指定工作目录
	dir "/tmp"
	
	# 指示 Sentinel 去监视一个名为 mymaster 的主服务器
	# 这个主服务器的 IP 地址为 127.0.0.1 ， 端口号为 6379
	# 将这个主服务器判断为失效至少需要 2 个 Sentinel 同意 （只要同意 Sentinel 的数量不达标，自动故障迁移就不会执行）。
	sentinel myid 8d8cc2507af849fddc1091f18a18652d07030f17
	
	# 指定多少毫秒没响应，则认为主节点挂了
	sentinel monitor mymaster 127.0.0.1 6379 1
	
	# 指定多少毫秒后，主节点还没响应，则从从节点中选出一个主节点
	sentinel down-after-milliseconds mymaster 60000
	
	# 如果master重新选出来后，其它slave节点能同时并行从新master同步缓存的台数有多少个
	# 最保定的设置为1，只同一时间，只能有一台干这件事，这样其它slave还能继续服务
	sentinel config-epoch mymaster 0
	
	# Generated by CONFIG REWRITE
	# 后面这些是哨兵启动后自动加上的
	sentinel leader-epoch mymaster 0
	sentinel known-slave mymaster 127.0.0.1 6381
	sentinel known-slave mymaster 127.0.0.1 6380
	sentinel known-sentinel mymaster 127.0.0.1 26380 c33038c9ef845a0eb26f71eafb734a5ccb4c9c51
	sentinel current-epoch 0

> 一个哨兵可以监控多个主-从架构，按照上面的再配置一次，修改监视的主服务器名称，ip和端口即可  
> 哨兵是可以配置多个的，使用同一份配置文件进行启动，此时两个哨兵是处于平等地位的


### 常用的哨兵命令


	info ： 查看sentinel的基本状态信息
	SENTINEL masters  ： 列出所有被监视的主服务器，以及这些主服务器的当前状态
	SENTINEL slaves <master name>  ：列出给定主服务器的所有从服务器，以及这些从服务器的当前状态
	SENTINEL get-master-addr-by-name <master name> ： 返回给定名字的主服务器的 IP 地址和端口号
	SENTINEL reset <pattern>  ： 重置所有名字和给定模式 pattern 相匹配的主服务器。重置操作清除主服务器目前的所有状态， 包括正在执行中的故障转移， 并移除目前已经发现和关联的， 主服务器的所有从服务器和 Sentinel 。
	SENTINEL failover <master name>  ： 当主服务器失效时， 在不询问其他 Sentinel 意见的情况下， 强制开始一次自动故障迁移，但是它会给其他sentinel发送一个最新的配置，其他sentinel会根据这个配置进行更新


































